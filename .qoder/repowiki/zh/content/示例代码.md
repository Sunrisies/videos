# 示例代码

<cite>
**本文引用的文件**
- [README.md](file://README.md)
- [QUICKSTART.md](file://app/downloader/QUICKSTART.md)
- [pyproject.toml](file://app/downloader/pyproject.toml)
- [requirements.txt](file://app/downloader/requirements.txt)
- [Cargo.toml](file://app/server/Cargo.toml)
- [main.rs](file://app/server/src/main.rs)
- [models.rs](file://app/server/src/models.rs)
- [routes/mod.rs](file://app/server/src/routes/mod.rs)
- [services/mod.rs](file://app/server/src/services/mod.rs)
- [utils/mod.rs](file://app/server/src/utils/mod.rs)
- [cli.py](file://app/downloader/cli/cli.py)
- [advanced_cli.py](file://app/downloader/cli/advanced_cli.py)
- [downloader.py](file://app/downloader/core/downloader.py)
- [advanced_downloader.py](file://app/downloader/core/advanced_downloader.py)
- [config.py](file://app/downloader/core/config.py)
- [run_cli.py](file://app/downloader/run_cli.py)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考量](#性能考量)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录](#附录)

## 引言
本项目是一个“视频文件服务器”，包含三部分：
- Rust + Axum 后端：提供视频列表、详情、静态文件服务、数据库与文件监听等能力；
- Python M3U8 下载模块：提供命令行与编程接口，支持多线程、断点续传、JSON批量下载；
- Next.js 前端：用于演示与交互（本仓库未包含前端实现细节，但提供了页面与组件骨架）。

本示例文档聚焦于“示例代码”的呈现与说明，帮助读者快速理解各模块的职责、调用方式与典型用法。

## 项目结构
整体采用多语言分层组织：
- app/server：Rust 后端，负责 API、静态文件、数据库与文件监听；
- app/downloader：Python 下载模块，包含 CLI、核心下载器、配置与工具；
- app/web：Next.js 前端（页面与组件骨架）。

```mermaid
graph TB
subgraph "后端(Rust)"
A_main["src/main.rs"]
A_routes["src/routes/*"]
A_services["src/services/*"]
A_utils["src/utils/*"]
A_models["src/models.rs"]
end
subgraph "下载器(Python)"
P_cli["cli/*.py"]
P_core["core/*.py"]
P_cfg["core/config.py"]
P_run["run_cli.py"]
end
subgraph "前端(Next.js)"
W_app["web/app/*"]
W_pages["web/app/videos/*"]
W_components["web/components/*"]
end
A_main --> A_routes
A_main --> A_services
A_main --> A_utils
A_main --> A_models
P_cli --> P_core
P_cli --> P_cfg
P_run --> P_cli
W_app --> W_pages
W_app --> W_components
```

图表来源
- [main.rs](file://app/server/src/main.rs#L1-L111)
- [routes/mod.rs](file://app/server/src/routes/mod.rs#L1-L6)
- [services/mod.rs](file://app/server/src/services/mod.rs#L1-L6)
- [utils/mod.rs](file://app/server/src/utils/mod.rs#L1-L14)
- [models.rs](file://app/server/src/models.rs#L1-L32)
- [cli.py](file://app/downloader/cli/cli.py#L1-L292)
- [advanced_cli.py](file://app/downloader/cli/advanced_cli.py#L1-L373)
- [downloader.py](file://app/downloader/core/downloader.py#L1-L501)
- [advanced_downloader.py](file://app/downloader/core/advanced_downloader.py#L1-L586)
- [config.py](file://app/downloader/core/config.py#L1-L114)
- [run_cli.py](file://app/downloader/run_cli.py#L1-L25)

章节来源
- [README.md](file://README.md#L253-L317)
- [main.rs](file://app/server/src/main.rs#L72-L110)
- [pyproject.toml](file://app/downloader/pyproject.toml#L1-L17)
- [requirements.txt](file://app/downloader/requirements.txt#L1-L3)

## 核心组件
- Rust 后端
  - 路由与中间件：CORS、静态文件服务、API 路由；
  - 数据模型：VideoInfo、VideoList；
  - 服务层：数据库管理、目录同步、文件监听、缩略图初始化；
  - 工具层：通用工具、时长计算、日志、M3U8 检测与合并、缩略图生成。
- Python 下载器
  - CLI：基础 CLI 与高级 CLI，支持交互、参数解析、模板配置；
  - 核心下载器：基础下载器与高级下载器，支持批量、流式、JSON 任务；
  - 配置：DownloadConfig、ConfigTemplates；
  - 工具：重试、进度、日志、校验与 URL 处理。

章节来源
- [models.rs](file://app/server/src/models.rs#L1-L32)
- [cli.py](file://app/downloader/cli/cli.py#L1-L292)
- [advanced_cli.py](file://app/downloader/cli/advanced_cli.py#L1-L373)
- [downloader.py](file://app/downloader/core/downloader.py#L1-L501)
- [advanced_downloader.py](file://app/downloader/core/advanced_downloader.py#L1-L586)
- [config.py](file://app/downloader/core/config.py#L1-L114)

## 架构总览
后端通过 Axum 提供 REST API 与静态文件服务；前端通过 Next.js 页面访问后端 API；下载器作为独立模块，既可通过命令行使用，也可通过编程接口集成到其他流程。

```mermaid
graph TB
FE["前端(Next.js)"] --> API["后端(Axum/Rust)"]
DL["下载器(Python)"] --> FS["本地文件系统(public)"]
API --> DB["数据库(rusqlite)"]
API --> FS
API --> TH["缩略图(thumbnails)"]
DL -.-> API
```

图表来源
- [main.rs](file://app/server/src/main.rs#L72-L110)
- [models.rs](file://app/server/src/models.rs#L1-L32)
- [Cargo.toml](file://app/server/Cargo.toml#L1-L23)
- [downloader.py](file://app/downloader/core/downloader.py#L379-L501)
- [advanced_downloader.py](file://app/downloader/core/advanced_downloader.py#L524-L586)

## 详细组件分析

### Rust 后端：路由与服务
- 路由
  - GET /api/videos：列出视频列表；
  - GET /api/videos/*path：获取指定路径的视频详情；
  - GET /api/sync：手动同步数据库；
  - GET /api/watcher/start | stop | status：文件监听器控制；
  - GET /public/*path：静态文件服务；
  - GET /thumbnails/*path：缩略图服务。
- 服务
  - 数据库：VideoDbManager、DirectorySync、VideoDao；
  - 文件系统：目录扫描、类型识别、元数据提取；
  - 文件监听：FileWatcher；
  - 工具：日志、M3U8 检测与合并、缩略图生成、时长计算。

```mermaid
sequenceDiagram
participant C as "客户端"
participant R as "Axum路由(main.rs)"
participant H as "处理器(routes/*)"
participant S as "服务(services/*)"
participant D as "数据库(rusqlite)"
participant F as "文件系统(public)"
C->>R : GET /api/videos
R->>H : list_videos()
H->>S : DirectorySync.initialize_from_directory()
S->>D : 初始化/读取视频索引
S->>F : 扫描目录与文件
S-->>H : 视频列表
H-->>R : JSON 响应
R-->>C : 200 OK
C->>R : GET /public/...
R->>F : ServeDir : : new("public")
R-->>C : 返回静态文件
```

图表来源
- [main.rs](file://app/server/src/main.rs#L72-L110)
- [routes/mod.rs](file://app/server/src/routes/mod.rs#L1-L6)
- [services/mod.rs](file://app/server/src/services/mod.rs#L1-L6)
- [Cargo.toml](file://app/server/Cargo.toml#L1-L23)

章节来源
- [main.rs](file://app/server/src/main.rs#L72-L110)
- [routes/mod.rs](file://app/server/src/routes/mod.rs#L1-L6)
- [services/mod.rs](file://app/server/src/services/mod.rs#L1-L6)
- [utils/mod.rs](file://app/server/src/utils/mod.rs#L1-L14)

### Python 下载器：CLI 与核心流程
- 基础 CLI
  - 参数解析：URL、输出、线程数、配置模板、超时、请求头、功能开关、交互模式；
  - 交互模式：引导输入 URL、配置模板、输出文件名，确认后执行下载；
  - 执行下载：构造 M3U8Downloader，解析 M3U8，批量下载 TS，合并为 MP4。
- 高级 CLI
  - 支持 JSON 配置文件，批量下载，控制最大并发；
  - 交互模式：单个下载、批量下载、创建 JSON 配置；
  - 执行下载：AdvancedM3U8Downloader，StreamDownloadManager，逐个下载 TS，合并为 MP4。
- 核心下载器
  - DownloadManager：线程池并发下载、断点续传、进度统计、日志、信号处理；
  - M3U8Downloader：解析 M3U8、下载未完成片段、合并、清理临时目录；
  - StreamDownloadManager：流式下载，逐个下载并实时显示进度；
  - AdvancedM3U8Downloader：批量任务管理、JSON 任务加载与保存。
- 配置
  - DownloadConfig：线程数、超时、重试、块大小、缓冲区、路径、请求头、SSL 校验、进度与日志；
  - ConfigTemplates：fast/stable/low_bandwidth 三种预设。

```mermaid
sequenceDiagram
participant U as "用户"
participant CLI as "M3U8CLI/AdvancedM3U8CLI"
participant D as "M3U8Downloader/AdvancedM3U8Downloader"
participant M as "DownloadManager/StreamDownloadManager"
participant P as "M3U8Parser"
participant FS as "文件系统"
U->>CLI : 传入参数/交互输入
CLI->>D : 构造下载器(含配置)
D->>P : parse_m3u8(url, headers)
P-->>D : ts_files, parse_info
D->>M : download_batch()/download_task()
M->>FS : 下载TS片段(并发/流式)
M-->>D : 下载结果
D->>M : merge_files(ts_files -> output.mp4)
M-->>D : 合并完成
D->>FS : 清理临时目录
D-->>CLI : 返回成功/失败
CLI-->>U : 打印结果与状态
```

图表来源
- [cli.py](file://app/downloader/cli/cli.py#L1-L292)
- [advanced_cli.py](file://app/downloader/cli/advanced_cli.py#L1-L373)
- [downloader.py](file://app/downloader/core/downloader.py#L379-L501)
- [advanced_downloader.py](file://app/downloader/core/advanced_downloader.py#L432-L586)
- [config.py](file://app/downloader/core/config.py#L1-L114)

章节来源
- [cli.py](file://app/downloader/cli/cli.py#L1-L292)
- [advanced_cli.py](file://app/downloader/cli/advanced_cli.py#L1-L373)
- [downloader.py](file://app/downloader/core/downloader.py#L1-L501)
- [advanced_downloader.py](file://app/downloader/core/advanced_downloader.py#L1-L586)
- [config.py](file://app/downloader/core/config.py#L1-L114)

### Python 下载器：类关系图
```mermaid
classDiagram
class DownloadConfig {
+int num_threads
+int connect_timeout
+int read_timeout
+int max_retries
+float retry_delay
+int chunk_size
+int buffer_size
+string temp_dir
+string output_dir
+dict headers
+bool verify_ssl
+bool show_progress
+bool enable_logging
+to_dict()
}
class ConfigTemplates {
+fast()
+stable()
+low_bandwidth()
}
class RetryHandler {
+int max_retries
+float retry_delay
+execute_with_retry(func, ...)
}
class M3U8Parser {
+parse_m3u8(url, headers)
}
class DownloadManager {
+session
+download_file(url, save_path, filename, cb)
+download_batch(urls, save_dir, desc)
+merge_files(file_list, output_file, temp_dir)
+cleanup_temp_dir(temp_dir)
}
class M3U8Downloader {
+url
+config
+parser
+manager
+download(output_file)
+stop()
+get_status()
}
class StreamDownloadManager {
+session
+download_file_stream(url, save_path, filename, task_name)
+download_task(task)
+download_batch_tasks(tasks, max_concurrent)
+merge_files(file_list, output_file, temp_dir)
+cleanup_task_temp_dir(task_temp_dir)
}
class DownloadTask {
+string name
+string url
+string output_dir
+dict params
+string status
+int progress
+string message
+to_dict()
}
class JSONTaskLoader {
+load_from_file(file_path, base_output_dir)
+save_to_file(tasks, file_path)
}
class AdvancedM3U8Downloader {
+config
+manager
+task_loader
+download_from_json(json_file, base_output_dir, max_concurrent)
+download_single(name, url, output_dir, params)
+stop()
}
DownloadConfig <|-- ConfigTemplates
RetryHandler <.. DownloadManager
RetryHandler <.. StreamDownloadManager
M3U8Parser <.. M3U8Downloader
DownloadManager <.. M3U8Downloader
StreamDownloadManager <.. AdvancedM3U8Downloader
JSONTaskLoader <.. AdvancedM3U8Downloader
DownloadTask <.. JSONTaskLoader
DownloadTask <.. StreamDownloadManager
```

图表来源
- [config.py](file://app/downloader/core/config.py#L1-L114)
- [downloader.py](file://app/downloader/core/downloader.py#L1-L501)
- [advanced_downloader.py](file://app/downloader/core/advanced_downloader.py#L1-L586)

章节来源
- [config.py](file://app/downloader/core/config.py#L1-L114)
- [downloader.py](file://app/downloader/core/downloader.py#L1-L501)
- [advanced_downloader.py](file://app/downloader/core/advanced_downloader.py#L1-L586)

### Python 下载器：算法流程（基础下载）
```mermaid
flowchart TD
Start(["开始"]) --> Parse["解析M3U8<br/>获取TS列表与解析信息"]
Parse --> Found{"找到TS片段?"}
Found --> |否| Fail["返回失败"]
Found --> |是| CheckExist["检查本地已下载片段"]
CheckExist --> NeedDL{"是否存在未下载片段?"}
NeedDL --> |否| Merge["合并TS为MP4"]
NeedDL --> |是| Batch["并发下载未完成片段"]
Batch --> Merge
Merge --> Cleanup["清理临时目录"]
Cleanup --> Done(["完成"])
Fail --> End(["结束"])
Done --> End
```

图表来源
- [downloader.py](file://app/downloader/core/downloader.py#L379-L501)

章节来源
- [downloader.py](file://app/downloader/core/downloader.py#L379-L501)

### Python 下载器：算法流程（高级流式下载）
```mermaid
flowchart TD
S(["开始任务"]) --> Parse["解析M3U8<br/>获取TS列表与解析信息"]
Parse --> Exists{"已存在片段?"}
Exists --> |是| Count["统计已下载数量"]
Exists --> |否| Empty["无已下载片段"]
Count --> Loop["逐个流式下载TS片段<br/>实时显示进度"]
Empty --> Loop
Loop --> Merge["合并TS为MP4"]
Merge --> Clean["清理任务临时目录"]
Clean --> End(["完成"])
```

图表来源
- [advanced_downloader.py](file://app/downloader/core/advanced_downloader.py#L432-L586)

章节来源
- [advanced_downloader.py](file://app/downloader/core/advanced_downloader.py#L432-L586)

## 依赖关系分析
- Python 下载器
  - 依赖 requests、tqdm；
  - CLI 通过相对导入访问 core 模块；
  - run_cli.py 通过 sys.path.insert 解决路径问题。
- Rust 后端
  - 依赖 axum、tokio、tower-http、serde、rusqlite、walkdir、notify、rayon 等；
  - 通过 env DATA_SOURCE_DIR 指定数据源目录，默认 public。

```mermaid
graph LR
P_req["Python: requests/tqdm"] --> P_mod["Python: downloader/*"]
P_mod --> P_cli["Python: cli/*"]
P_mod --> P_core["Python: core/*"]
R_axum["Rust: axum/tokio"] --> R_srv["Rust: services/*"]
R_srv --> R_db["rusqlite"]
R_srv --> R_fs["walkdir/notify/rayon"]
```

图表来源
- [requirements.txt](file://app/downloader/requirements.txt#L1-L3)
- [pyproject.toml](file://app/downloader/pyproject.toml#L1-L17)
- [Cargo.toml](file://app/server/Cargo.toml#L1-L23)

章节来源
- [requirements.txt](file://app/downloader/requirements.txt#L1-L3)
- [pyproject.toml](file://app/downloader/pyproject.toml#L1-L17)
- [Cargo.toml](file://app/server/Cargo.toml#L1-L23)

## 性能考量
- 并发与线程
  - 默认线程数为 CPU 核心数的倍数，可通过配置模板或参数调整；
  - 高级下载器支持最大并发任务数控制，避免资源争用。
- 超时与重试
  - 连接与读取超时可配置，指数退避重试降低瞬时失败影响；
  - SSL 校验可关闭（仅在受信任环境下使用）。
- I/O 与缓冲
  - 分块下载与写入缓冲减少内存占用；
  - 合并阶段使用缓冲区读取，避免大文件内存压力。
- 前端与后端
  - 后端使用异步 Tokio，支持高并发；
  - 静态文件服务通过 ServeDir 提供高效访问；
  - 缩略图与元数据可按需生成，减少重复计算。

章节来源
- [config.py](file://app/downloader/core/config.py#L1-L114)
- [downloader.py](file://app/downloader/core/downloader.py#L1-L501)
- [advanced_downloader.py](file://app/downloader/core/advanced_downloader.py#L1-L586)
- [main.rs](file://app/server/src/main.rs#L72-L110)
- [Cargo.toml](file://app/server/Cargo.toml#L1-L23)

## 故障排查指南
- Python 下载器
  - 模块导入错误：确保从 app 目录运行或使用 run_cli.py；
  - URL 校验失败：确认 URL 格式正确，必要时使用交互模式；
  - 进度与日志：可通过配置禁用进度或开启日志；
  - 中断与清理：支持 Ctrl+C 中断，下载器会清理临时目录。
- Rust 后端
  - 端口占用：默认 3003，可修改；
  - CORS：默认允许所有来源；
  - 数据库初始化：首次启动会尝试从 public 目录初始化；
  - 文件监听：默认不启动，可通过 /api/watcher/start 启动。

章节来源
- [run_cli.py](file://app/downloader/run_cli.py#L1-L25)
- [cli.py](file://app/downloader/cli/cli.py#L1-L292)
- [advanced_cli.py](file://app/downloader/cli/advanced_cli.py#L1-L373)
- [main.rs](file://app/server/src/main.rs#L72-L110)

## 结论
本项目通过 Rust 后端提供高性能视频服务，结合 Python 下载器实现 M3U8 视频的多线程、断点续传与批量下载能力。CLI 与编程接口清晰易用，配置模板覆盖不同网络与性能需求。前后端分离的设计便于扩展与维护。

## 附录
- 快速开始与命令示例参见下载器使用指南；
- 后端 API 与静态文件访问参见项目根 README；
- 前端页面与组件参见 web 目录结构与说明。

章节来源
- [QUICKSTART.md](file://app/downloader/QUICKSTART.md#L1-L290)
- [README.md](file://README.md#L102-L165)